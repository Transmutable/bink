<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../">
  <title data-ice="title">src/DataObject.js | bink</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  <script src="script/manual.js"></script>
<meta name="description" content="A sleek and reactive framework for web pages"><meta property="twitter:card" content="summary"><meta property="twitter:title" content="bink"><meta property="twitter:description" content="A sleek and reactive framework for web pages"></head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
<a style="position:relative; top:3px;" href="https://github.com/Transmutable/bink"><img width="20px" src="./image/github.png"></a></header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/App.js~App.html">App</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Component.js~Component.html">Component</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/DataCollection.js~DataCollection.html">DataCollection</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/DataModel.js~DataModel.html">DataModel</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/DataObject.js~DataObject.html">DataObject</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/EventHandler.js~EventHandler.html">EventHandler</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Localizer.js~Localizer.html">Localizer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Localizer.js~Translation.html">Translation</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/MockService.js~MockService.html">MockService</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Router.js~Route.html">Route</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Router.js~Router.html">Router</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-ld">ld</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-ldo">ldo</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-ldt">ldt</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-lt">lt</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-throttle">throttle</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-dom">dom</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-throttledConsoleLog">throttledConsoleLog</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#components-atoms">components/atoms</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/components/atoms/AudioComponent.js~AudioComponent.html">AudioComponent</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/components/atoms/ButtonComponent.js~ButtonComponent.html">ButtonComponent</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/components/atoms/HeadingComponent.js~HeadingComponent.html">HeadingComponent</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/components/atoms/ImageComponent.js~ImageComponent.html">ImageComponent</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/components/atoms/LabelComponent.js~LabelComponent.html">LabelComponent</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/components/atoms/MultiComponent.js~MultiComponent.html">MultiComponent</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/components/atoms/ProgressComponent.js~ProgressComponent.html">ProgressComponent</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/components/atoms/SelectionComponent.js~SelectionComponent.html">SelectionComponent</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/components/atoms/SliderComponent.js~SliderComponent.html">SliderComponent</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/components/atoms/SwitchComponent.js~SwitchComponent.html">SwitchComponent</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/components/atoms/TextComponent.js~TextComponent.html">TextComponent</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/components/atoms/TextInputComponent.js~TextInputComponent.html">TextInputComponent</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/components/atoms/ToggleComponent.js~ToggleComponent.html">ToggleComponent</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/components/atoms/VideoComponent.js~VideoComponent.html">VideoComponent</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#components-molecules">components/molecules</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/components/molecules/AudioPlayerComponent.js~AudioPlayerComponent.html">AudioPlayerComponent</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/components/molecules/ButtonGroupComponent.js~ButtonGroupComponent.html">ButtonGroupComponent</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/components/molecules/CardComponent.js~CardComponent.html">CardComponent</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/components/molecules/FormComponent.js~DateFieldComponent.html">DateFieldComponent</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/components/molecules/FormComponent.js~FormComponent.html">FormComponent</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/components/molecules/FormComponent.js~FormFieldComponent.html">FormFieldComponent</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/components/molecules/FormComponent.js~SelectionFieldComponent.html">SelectionFieldComponent</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/components/molecules/FormComponent.js~SwitchFieldComponent.html">SwitchFieldComponent</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/components/molecules/FormComponent.js~TextInputFieldComponent.html">TextInputFieldComponent</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/components/molecules/ImageCardComponent.js~ImageCardComponent.html">ImageCardComponent</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/components/molecules/MenuComponent.js~MenuComponent.html">MenuComponent</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/components/molecules/ModalComponent.js~ModalComponent.html">ModalComponent</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/components/molecules/PaginationComponent.js~PaginationComponent.html">PaginationComponent</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/components/molecules/ToolTipComponent.js~ToolTipComponent.html">ToolTipComponent</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/components/molecules/VideoPlayerComponent.js~VideoPlayerComponent.html">VideoPlayerComponent</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/components/molecules/WaitComponent.js~WaitComponent.html">WaitComponent</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#components-organisms">components/organisms</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/components/organisms/CollectionComponent.js~CollectionComponent.html">CollectionComponent</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/components/organisms/CollectionComponent.js~DefaultItemComponent.html">DefaultItemComponent</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/components/organisms/MastheadComponent.js~MastheadComponent.html">MastheadComponent</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/components/organisms/MediaGridComponent.js~MediaGridComponent.html">MediaGridComponent</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">src/DataObject.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">import EventHandler from &apos;./EventHandler.js&apos;

/**
`DataObject` is the base class for {@link DataModel} and {@link DataCollection}.

It holds the event handling and the generic function of fetching data from a remote service
*/
const DataObject = class extends EventHandler {
	/**
	@param {Object} [options={}] Not used by DataObject but helpful for extending classes
	*/
	constructor(options = {}) {
		super()
		/** @type {Object&lt;string,*&gt;} */
		this.options = options
		this._new = true // True until the first fetch returns, regardless of http status
		/** True after {@link DataObject.cleanup} has been called. */
		this.cleanedUp = false
	}

	/**
	When models are no longer needed `cleanup` should be called to release resources like event listeners.

	@return {DataObject} returns `this` for easy chaining
	*/
	cleanup() {
		if (this.cleanedUp) return
		this.cleanedUp = true
		super.cleanup()
		return this
	}

	/**
	True until a fetch (even a failed fetch) returns	

	@return {boolean}
	*/
	get isNew() {
		return this._new
	}

	/**
	The URL (relative or full) as a string for the endpoint used by {@link DataObject.fetch}.
	@return {string} 
	*/
	get url() {
		throw new Error(&apos;Extending classes must implement url()&apos;)
	}

	/** Clear out old data and set it to data, should trigger a &apos;reset&apos; event */
	reset(data = {}) {
		throw new Error(&apos;Extending classes must implement reset&apos;)
	}

	/** Extending classes can override this to parse the data received via a fetch */
	parse(data) {
		return data
	}

	/** Extending classes can override this to allow less strict equality */
	equals(obj) {
		return this === obj
	}

	/**
	If already reset, immediately call callback, otherwise wait until the first reset and then call callback

	@example
	class ExampleModel extends DataModel {
		get url() { return &apos;/api/example&apos; }
	}
	const model = new ExampleModel()
	model.onFirstReset((model) =&gt; { ... })
	model.fetch()
	// the callback passed to onFirstReset will be called when the fetch completes

	@param {func(dataObject: DataObject)} callback
	*/
	onFirstReset(callback) {
		if (this._new) {
			this.addListener(
				&apos;reset&apos;,
				() =&gt; {
					callback(this)
				},
				true
			)
		} else {
			callback(this)
		}
	}
	/**
	Extending classes can override this to add headers, methods, etc to the fetch call

	By default the only fetch option set is `credentials: same-origin&apos;.

	@return {Object}
	*/
	get fetchOptions() {
		return {
			credentials: &apos;same-origin&apos;,
		}
	}

	/**
	Ask the server for data for this model or collection.

	Depends on {@link DataObject.url}, {@link DataObject.parse} and {@link DataObject.reset}.

	@return {Promise&lt;DataObject, Error&gt;}
	*/
	fetch() {
		return new Promise(
			function (resolve, reject) {
				this.trigger(&apos;fetching&apos;, this)
				this._innerFetch(this.url, this.fetchOptions)
					.then((response) =&gt; {
						if (response.status != 200) {
							throw &apos;Fetch failed with status &apos; + response.status
						}
						return response.json()
					})
					.then((data) =&gt; {
						data = this.parse(data)
						this._new = false
						this.reset(data)
						this.trigger(&apos;fetched&apos;, this, data, null)
						resolve(this)
					})
					.catch((err) =&gt; {
						this._new = false
						this.trigger(&apos;fetched&apos;, this, null, err)
						reject(err)
					})
			}.bind(this)
		)
	}

	/**
	This overrides the use of window.fetch, mostly during testing.

	For example, MockService overrides this to intercept fetch calls and return its own responses for matched endpoints
	*/
	_innerFetch(...params) {
		return fetch(...params)
	}

	/**
	Fetch each DataObject and then wait for them all to return

	This resolves when the fetches complete, regardless of whether they succeed or fail.

	@example
	this.model = new DataModel()
	this.collection = new DataCollection()
	DataObject.fetchAll(model, collection).then((mod, col) =&gt; { ... })

	@param {...DataObject} dataObjects
	@return {Promise&lt;...DataObjects&gt;,Error&gt;}
	*/
	static fetchAll(...dataObjects) {
		const allAreFetched = () =&gt; {
			for (const dataObject of dataObjects) {
				if (dataObject.isNew) return false
			}
			return true
		}
		return new Promise((resolve, reject) =&gt; {
			if (allAreFetched()) {
				resolve(...dataObjects)
				return
			}
			for (const dataObject of dataObjects) {
				dataObject
					.fetch()
					.then(() =&gt; {
						if (allAreFetched()) resolve(...dataObjects)
					})
					.catch((err) =&gt; {
						if (allAreFetched()) resolve(...dataObjects)
					})
			}
		})
	}

	/**
	Tell the server to create (POST) or update (PUT) this model or collection.

	If {@link DataObject.isNew} is true it will POST, otherwise it will PUT.

	@return {Promise&lt;DataObject,Error&gt;}
	*/
	save() {
		return new Promise(
			function (resolve, reject) {
				this.trigger(&apos;saving&apos;, this)
				const options = Object.assign({}, this.fetchOptions)
				if (this.isNew) {
					options.method = &apos;post&apos;
				} else {
					options.method = &apos;put&apos;
				}
				options.body = JSON.stringify(this.data)
				this._innerFetch(this.url, options)
					.then((response) =&gt; {
						if (response.status != 200) {
							throw &apos;Save failed with status &apos; + response.status
						}
						return response.json()
					})
					.then((data) =&gt; {
						data = this.parse(data)
						this.reset(data)
						this._new = false
						this.trigger(&apos;saved&apos;, this, data, null)
						resolve(this)
					})
					.catch((err) =&gt; {
						this.trigger(&apos;saved&apos;, this, null, err)
						reject(err)
					})
			}.bind(this)
		)
	}

	/**
	Call `DELETE` on this object&apos;s remote endpoint.

	@return {Promise&lt;undefined,Error&gt;}
	*/
	delete() {
		return new Promise(
			function (resolve, reject) {
				this.trigger(&apos;deleting&apos;, this)
				const options = Object.assign({}, this.fetchOptions)
				options.method = &apos;delete&apos;
				this._innerFetch(this.url, options)
					.then((response) =&gt; {
						if (response.status != 200) {
							throw &apos;Delete failed with status &apos; + response.status
						}
						this.trigger(&apos;deleted&apos;, this, null)
						resolve()
					})
					.catch((err) =&gt; {
						this.trigger(&apos;deleted&apos;, this, err)
						reject(err)
					})
			}.bind(this)
		)
	}
}

DataObject._NO_CHANGE = Symbol(&apos;no change&apos;)

export default DataObject
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(1.1.0)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
